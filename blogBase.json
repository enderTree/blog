{"singlePage": ["resume"], "startSite": "", "filingNum": "", "onePageListNum": 15, "commentLabelColor": "#006b75", "yearColorList": ["#bc4c00", "#0969da", "#1f883d", "#A333D0"], "i18n": "CN", "themeMode": "manual", "dayTheme": "light", "nightTheme": "dark", "urlMode": "pinyin", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "style": "", "head": "", "indexScript": "", "indexStyle": "", "bottomText": "", "showPostSource": 1, "iconList": {"resume": "M3 7.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-3Zm10 .25a.75.75 0 0 1-.75.75h-4.5a.75.75 0 0 1 0-1.5h4.5a.75.75 0 0 1 .75.75ZM10.25 11a.75.75 0 0 0 0-1.5h-2.5a.75.75 0 0 0 0 1.5h2.5Z M7.25 0h1.5c.966 0 1.75.784 1.75 1.75V3h3.75c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25v-8.5C0 3.784.784 3 1.75 3H5.5V1.75C5.5.784 6.284 0 7.25 0Zm3.232 4.5A1.75 1.75 0 0 1 8.75 6h-1.5a1.75 1.75 0 0 1-1.732-1.5H1.75a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25ZM7 1.75v2.5c0 .138.112.25.25.25h1.5A.25.25 0 0 0 9 4.25v-2.5a.25.25 0 0 0-.25-.25h-1.5a.25.25 0 0 0-.25.25Z"}, "UTC": 8, "rssSplit": "sentence", "exlink": {}, "needComment": 1, "allHead": "", "title": "ender'Blog", "subTitle": "\u95ed\u5173ING", "avatarUrl": "https://github.githubassets.com/favicons/favicon.svg", "GMEEK_VERSION": "last", "postListJson": {"P1": {"htmlDir": "docs/post/test.html", "labels": ["sql"], "postTitle": "test", "postUrl": "post/test.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/1", "commentNum": 1, "wordCount": 518, "description": "```sql\n\nSELECT\n    *\nFROM\n(\n\n    SELECT\n        tag,\n        doc_cnt,\n        (doc_cnt/SUM(doc_cnt) OVER())*100\n    FROM\n    (\n        SELECT \n            tag,\n            SUM(doc_cnt) AS doc_cnt\n        FROM\n            dwd_crawler_host_classification_di a\n        LEFT ANTI JOIN \n            tmp_gumu_data_0624_2 b\n            ON a.host = b.host\n        WHERE\n            ymd = '2025-06-23'\n            AND tag_type = 'topic'\n        GROUP BY \n            tag\n    )\n)\nWHERE \n    tag = 'Advertising_&_Marketing'\n;\n```\u3002", "top": 0, "createdAt": 1750819859, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}, "P2": {"htmlDir": "docs/post/chuang-kou-han-shu-de-yi-xie-shi-yong.html", "labels": ["sql"], "postTitle": "\u7a97\u53e3\u51fd\u6570\u7684\u4e00\u4e9b\u4f7f\u7528", "postUrl": "post/chuang-kou-han-shu-de-yi-xie-shi-yong.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/2", "commentNum": 0, "wordCount": 452, "description": "#### 1. \u53d6\u6700\u8fd1\u4e00\u4e2a\u4e0d\u4e3a\u7a7a\u7684\u503c\u586b\u5145\n```sql\nWITH mian_data AS (\n    SELECT\n        c0,\n        c1,\n        IF(c1 = '\u5904\u7f6e', NULL, c2) AS c2\n    FROM\n        VALUES\n         (1,'\u5904\u7f6e','1')\n        ,(2,'\u5904\u7f6e','2')\n        ,(3,'\u5904\u7f6e','3')\n        ,(4,'\u5904\u7f6e','4')\n        ,(5,'\u63d0\u4ea4','A')\n        ,(6,'\u5904\u7f6e','5')\n        ,(7,'\u63d0\u4ea4','b')\n    AS a(c0,c1,c2)\n)\nSELECT \n    *,\n    FIRST_VALUE(c2, True) over(order by c0 ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING)\nFROM \n    mian_data \n```\u3002", "top": 0, "createdAt": 1750822716, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}, "P3": {"htmlDir": "docs/post/jie-jue-Join-shu-ju-qing-xie.html", "labels": ["sql"], "postTitle": "\u89e3\u51b3Join\u6570\u636e\u503e\u659c", "postUrl": "post/jie-jue-Join-shu-ju-qing-xie.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/3", "commentNum": 0, "wordCount": 1836, "description": "\u4f18\u5316\u524d\uff1a\n```sql\nSELECT \n        /*+ mapjoin(dd),skewjoin(a(url))*/\n        a.* except(url_tag, join_key),\n        CASE \n            WHEN cc.url IS NOT NULL THEN 'black_url'\n            WHEN dd.url IS NOT NULL THEN 'black_url'\n            ELSE ''\n        END AS url_tag\n    FROM\n    (\n        select \n            *,\n            1 AS join_key\n        from \n            dwd_crawler_urls_step1_di a \n        where \n            ymd = '${P_DATE}'\n            AND url_tag != 'black_url'\n    ) as\n    LEFT JOIN \n        black_urls2 cc  \n        ON replace(a.host, 'www.', '') = replace(cc.url, 'www.', '')\n\tLEFT JOIN \n        black_urls1 dd  \n        ON INSTR(a.url, dd.url) > 0\n```\n\u4f18\u5316\u540e\n```sql\nSELECT \n        /*+ mapjoin(dd),skewjoin(a(url))*/\n        a.* except(url_tag, join_key),\n        CASE \n            WHEN cc.url IS NOT NULL THEN 'black_url'\n            WHEN dd.url IS NOT NULL THEN 'black_url'\n            ELSE ''\n        END AS url_tag\n    FROM\n    (\n        select \n            *,\n            1 AS join_key\n        from \n            dwd_crawler_urls_step1_di a \n        where \n            ymd = '${P_DATE}'\n            AND url_tag != 'black_url'\n    ) a\n    LEFT JOIN \n        black_urls1 dd  \n        ON INSTR(a.url, dd.url) > 0\n    LEFT JOIN \n        black_urls2 cc  \n        ON replace(a.host, 'www.', '') = replace(cc.url, 'www.', '')\n```\n\u4f18\u5316\u524d\u6267\u884c\u65f6\u95f4\n\n<img width='991' alt='Image' src='https://github.com/user-attachments/assets/3d62cdfd-b1e0-4579-adc9-a8bc19ac64ff' />\n\n<img width='872' alt='Image' src='https://github.com/user-attachments/assets/46033d2f-9fbe-4400-b6c6-489f97ee7f00' />\n\n\u4f18\u5316\u540e\u6267\u884c\u65f6\u95f4\n\n<img width='978' alt='Image' src='https://github.com/user-attachments/assets/74de5fc3-08ff-4ed6-8c94-9b0d31c18799' />\n\n<img width='944' alt='Image' src='https://github.com/user-attachments/assets/b2f397da-420d-484b-9655-3dda6ee57046' />\n\u3002", "top": 0, "createdAt": 1750822743, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}, "P4": {"htmlDir": "docs/post/quan-ju-pai-xu-you-hua.html", "labels": ["sql"], "postTitle": "\u5168\u5c40\u6392\u5e8f\u4f18\u5316", "postUrl": "post/quan-ju-pai-xu-you-hua.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/4", "commentNum": 0, "wordCount": 1240, "description": "```sql\n\nCREATE TABLE talkie_dialogue.tmp_nana_data_1028_555 AS \nWITH hash_bucket AS (\n    SELECT  \n        *,\n        ROW_NUMBER() OVER (PARTITION BY bucket_no ORDER BY user_msg_log_ucnt_30d ASC ) AS bucket_rel_index,\n        COUNT(1) OVER (PARTITION BY bucket_no ) AS bucket_size\n    FROM    \n    (\n        SELECT  \n            *,\n            ABS(HASH(cid)) % 100000 AS bucket_no \n        FROM    \n            talkie_dialogue.tmp_nana_data_1028_4            \n    ) \n),\nbucket_base AS \n(\n    SELECT\n        bucket_no\n        SUM(bucket_size) OVER (ORDER BY bucket_no ASC) - bucket_size AS bucket_base\n    FROM\n    (\n        SELECT \n            bucket_no,\n            bucket_size\n        FROM\n            hash_bucket\n    )\n)\nSELECT\n    /*+ MAPJOIN(t2) */ t1.*,\n    t2.bucket_base + bucket_rel_index AS id_index\nFROM\n    hash_bucket t1 \nJOIN \n    bucket_base t2 \n    ON t1.bucket_no = t2.bucket_no\n    AND t1.mid_rank = t2.mid_rank\n    AND t1.country_rank = t2.country_rank\n    AND t1.setting_type = t2.setting_type\n;\n```\n\n\u6838\u5fc3\u4ee3\u7801\u5982\u4e0a\uff0c\u4e3b\u8981\u601d\u8def\u5148\u505a\u5206\u6876\u8fdb\u884c\u5206\u5e03\u5f0f\u5c40\u90e8\u6392\u5e8f\u3001\u518d\u57fa\u4e8e\u6876\u5927\u5c0f\u5f97\u5230\u5168\u5c40\u7d22\u5f15\n\n1. \u7b2c\u4e00\u6b65\u5148\u5bf9id\u505ahash\u5206\u6876\uff0c\u7136\u540e\u8ba1\u7b97\u6bcf\u4e2a\u6876\u7684\u5927\u5c0f\uff0c\u6876\u6570\u91cf\u53ef\u4ee5\u6839\u636e\u9700\u8981\u8ba1\u7b97\u7684id\u6570\u91cf\u6765\u8bc4\u4f30\uff0c\u8fd9\u91cc\u5206100000\u4e2a\u6876\uff0c\u7136\u540e\u8ba1\u7b97\u51fa\u6bcf\u4e2aid\u5728\u6876\u5185\u7684\u76f8\u5bf9\u4f4d\u7f6ebucket_rel_index\uff0c\u540c\u65f6\u8ba1\u7b97\u51fa\u6876\u5927\u5c0fbucket_size\uff1b\n2. \u7b2c\u4e8c\u6b65\u6839\u636e\u6876\u5927\u5c0f\u8ba1\u7b97\u6bcf\u4e2a\u6876\u7684\u57fa\u5740\uff1b\n3. \u7b2c\u4e09\u6b65\u5c06\u6876\u57fa\u5740+id\u5728\u6876\u5185\u7684\u76f8\u5bf9\u5730\u5740\u5f97\u5230\u5168\u5c40\u552f\u4e00\u7684\u7edd\u5bf9\u5730\u5740id_index\uff1b\n\n\u3002", "top": 0, "createdAt": 1750822762, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}, "P5": {"htmlDir": "docs/post/biao-ming-ming-gui-fan.html", "labels": ["\u6570\u4ed3"], "postTitle": "\u8868\u547d\u540d\u89c4\u8303", "postUrl": "post/biao-ming-ming-gui-fan.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/5", "commentNum": 0, "wordCount": 341, "description": "\n### 1. \u6570\u4ed3\u5206\u5c42\n\u6309 ods -> dwd -> dwm -> dws ->ads \u6765\u505a\n- dwd\uff1a\u4e8b\u5b9e\u7ea7\u522b\u7684\u660e\u7ec6\uff0c\u6216\u8005did uid\u7ea7\u7684\u6570\u636e\u3002", "top": 0, "createdAt": 1750836617, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}, "P6": {"htmlDir": "docs/post/MaxCompute-wai-biao-shi-yong.html", "labels": ["sql"], "postTitle": "MaxCompute\u5916\u8868\u4f7f\u7528", "postUrl": "post/MaxCompute-wai-biao-shi-yong.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/6", "commentNum": 0, "wordCount": 2570, "description": "### 1. \u5efa\u8868\n1. json\u683c\u5f0f\n\n```sql\nCREATE EXTERNAL TABLE IF NOT EXISTS dialogue.dwd_ext_xingye_log_chatml_data(\n    `data` STRING\n) \nPARTITIONED BY (\n    data_type STRING,\n    ymd STRING) \nROW FORMAT SERDE 'org.apache.hive.hcatalog.data.JsonSerDe' \nSTORED AS INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' \nOUTPUTFORMAT 'org.apache.hadoop.mapred.TextOutputFormat' \nLOCATION 'oss://data-dlc/minimax-dialogue/data/chatml/';\n```\n\n2. parquet\u683c\u5f0f\n   ```sql\n   CREATE EXTERNAL TABLE dwd_crawler_html_out_di\n   (\n      url string,\n       html string,\n       source_tag string,\n       lang string\n   )\n   partitioned BY (ymd string)\n   stored AS parquet  \n   location 'oss://data-dlc/minimax-dialogue/data/chatml/data_type=html_data/';\n   ```\n3. \u81ea\u5b9a\u4e49\u89e3\u6790\u5668\n```sql\nCREATE EXTERNAL TABLE ods_crawler_sites_warc_data_extract_result_external_hi (\n    warc_host string,\n    meta_info string,\n    final_url string,\n    status_code string,\n    data_dt string,\n    biz_code string,\n    target_url string,\n    warc_date string,\n    content_type string,\n    content_length string,\n    warc_file_name string,\n    content string,\n    import_msg string\n)\nPARTITIONED BY (\n    host string,\n    status string,\n    ymd string,\n    hour string\n)\nstored BY 'com.crawler.udf.sites_warc.WarcStorageHandler' \nwith serdeproperties (\n    'max_file_size' = '157286400'\n) \nLOCATION 'oss://crawler-data-storage/Crawlerlee/'\nUSING 'crawler_udf-1.0-SNAPSHOT.jar'\n```\n\u53ef\u53c2\u8003\u8fd9\u7bc7\u6587\u7ae0\n\n### 2. \u4f7f\u7528\n1. \u63d2\u5165\u6570\u636e\n```sql\nSET odps.sql.unstructured.oss.commit.mode = true; -- \u9632\u6b62\u751f\u6210.odps\u6587\u4ef6\u5939\nINSERT OVERWRITE TABLE dwd_crawler_html_out_di PARTITION(ymd='${P_DATE}')\nSELECT \n    a.source_url,\n    html,\n    biz_code,\n    parse_lang\nFROM \n    dwd_crawler_content_filtered_detail_byscore_di a\nWHERE \n    a.ymd = '${P_DATE}'\n    AND a.score_level != 'low'\n    AND COALESCE(html, '') != ''\n```\n2. \u8bfb\u53d6\u6570\u636e\n```\n-- \u626b\u63cf\u6240\u6709\u8def\u5f84\nmsck TABLE ods_crawler_sites_warc_data_extract_result_external_hi ADD partitions;\n-- \u626b\u63cf\u6307\u5b9a\u8def\u5f84\nALTER TABLE ods_crawler_sites_warc_data_extract_result_external_hi ADD IF NOT EXISTS \nPARTITION (host='demo.com',status='error',ymd='20250624', hour='09') \nPARTITION (host='demo.com',status='success',ymd='20250624', hour='09')\n;\n-- \u6307\u5b9alocation\nALTER TABLE log_table_external ADD PARTITION (year = '2016', month = '06', day = '01')\nlocation 'oss://oss-cn-hangzhou-internal.aliyuncs.com/bucket\u540d\u79f0/oss-odps-test/log_data_customized/2016/06/01/';\n-- \u6307\u5b9a\u8def\u5f84\u6620\u5c04\nMSCK REPAIR TABLE  ods_crawler_sites_warc_data_extract_result_external_hi ADD PARTITIONS\nWITH PROPERTIES ('odps.msck.partition.column.mapping'='host:host,status:status,ymd:ymd');\n```\u3002", "top": 0, "createdAt": 1750837119, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}, "P7": {"htmlDir": "docs/post/a-li-yun-ge-ren-shi-yong-de-yi-xie-zi-shi.html", "labels": ["\u6570\u4ed3"], "postTitle": "\u963f\u91cc\u4e91\u4e2a\u4eba\u4f7f\u7528\u7684\u4e00\u4e9b\u59ff\u52bf", "postUrl": "post/a-li-yun-ge-ren-shi-yong-de-yi-xie-zi-shi.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/7", "commentNum": 0, "wordCount": 8249, "description": "# \u963f\u91cc\u4e91\u4e2a\u4eba\u4f7f\u7528\u7684\u4e00\u4e9b\u59ff\u52bf\n\n## \u4e00\u3001\u767b\u5f55\n\n[\u767b\u5f55 dataworks](https://dataworks.console.aliyun.com/workspace/list)\uff0c\u9009\u62e9\u5bf9\u5e94\u5de5\u4f5c\u7a7a\u95f4\u8fdb\u5165\uff0c\u663e\u793a\u65e0\u7a7a\u95f4\u627e\u7ba1\u7406\u5458\u5f00\u901a\n\n<img width='1693' alt='Image' src='https://github.com/user-attachments/assets/b2e470eb-06e2-4c2c-8d12-da6232adc7b2' />\n\n<img width='1238' alt='Image' src='https://github.com/user-attachments/assets/2408c27a-fcf3-4631-a68a-2f3005c49936' />\n\n## \u4e8c\u3001\u4e34\u65f6 Sql \u8fd0\u884c\n\n\u4e34\u65f6\u67e5\u8be2\u4e0b\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55\uff0c\u5728\u4e0b\u9762\u65b0\u5efa odps sql \u8282\u70b9\u5373\u53ef\n\n## \u4e09\u3001\u5468\u671f\u4efb\u52a1\n\n### sql \u4efb\u52a1\n\n\u4e1a\u52a1\u6d41\u7a0b MaxCompute \u6570\u636e\u5f00\u53d1\u76ee\u5f55\u4e0b\u65b0\u5efa ODPS Sql \u8282\u70b9\n\n### PySpark \u7b80\u5355\u6a21\u5f0f\n\n[\u5b98\u65b9\u6587\u6863](https://help.aliyun.com/zh/maxcompute/user-guide/develop-a-spark-on-maxcompute-application-by-using-pyspark?spm=a2c4g.11186623.0.i2)\n\n1. \u8d44\u6e90\u4e2d\u65b0\u5efa python \u811a\u672c\n   \n<img width='443' alt='Image' src='https://github.com/user-attachments/assets/9e325886-5153-4c75-b19b-23fa6476f1b6' />\n\n ```python\nfrom pyspark.sql import SparkSession\nif __name__ == '__main__':\nspark = SparkSession.builder.appName('spark sql').getOrCreate()\nspark.sql('SELECT 1').show()\n```\n2. \u6570\u636e\u5f00\u53d1\u6587\u4ef6\u5939\u65b0\u5efaodps spark\u8282\u70b9\n\n<img width='735' alt='Image' src='https://github.com/user-attachments/assets/e4a30db5-a9b3-4110-bd83-85c764450f39' />\n\n\u53d1\u5e03\u4e0a\u7ebf\u7686\u53ef\uff0csparkui\u4f1a\u5728\u65e5\u5fd7\u4e2d\u6253\u5370\n\n### PySpark\u517c\u5bb9\u6a21\u5f0f\n\n\u963f\u91cc\u4e91\u7684PySpark\u662f\u57fa\u4e8ePython 3.7 + Spark2\u7684\uff0c\u800c\u4e14\u770b\u4e0a\u53bb\u5df2\u7ecf\u758f\u4e8e\u7ef4\u62a4\u4e86\u3002", "top": 0, "createdAt": 1750849572, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}, "P9": {"htmlDir": "docs/post/shi-yong-MaxFrame-jiang-oss-wen-jian-ru-ku.html", "labels": ["sql", "python"], "postTitle": "\u4f7f\u7528MaxFrame\u5c06oss\u6587\u4ef6\u5165\u5e93", "postUrl": "post/shi-yong-MaxFrame-jiang-oss-wen-jian-ru-ku.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/9", "commentNum": 0, "wordCount": 7372, "description": "1. oss\u914d\u7f6e\n```python\nOSS_ACCESS_ID = ''  # OSS \u7684 Access ID\nOSS_SECRET_ACCESS_KEY = ''  # OSS \u7684 Secret ID\n\n# \u586b\u5199 Bucket \u4fe1\u606f\nOSS_INTERNET_ENDPOINT = (\n    'oss-cn-shanghai.aliyuncs.com'  # OSS \u7684\u516c\u7f51\u8bbf\u95ee endpoint\uff0c\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528 sts token\n)\nOSS_INTERNAL_ENDPOINT = 'oss-cn-shanghai-internal.aliyuncs.com'  # OSS \u7684\u516c\u7f51\u8bbf\u95ee endpoint\uff0c\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528 sts token\nOSS_BUCKET_NAME = 'crawler-data-storage'  # OSS Bucket \u7684\u540d\u5b57\nOSS_BUCKET_ENDPOINT = f'{OSS_BUCKET_NAME}.{OSS_INTERNET_ENDPOINT}:80'\nOSS_BUCKET_ENDPOINT\n\nimport oss2\nfrom oss2 import defaults\ndefaults.connection_pool_size = 50\n\nauth = oss2.Auth(OSS_ACCESS_ID, OSS_SECRET_ACCESS_KEY)\nbucket = oss2.Bucket(auth, OSS_INTERNET_ENDPOINT, OSS_BUCKET_NAME)\n```\n2. \u5b9a\u4e49oss\u6587\u4ef6\u626b\u63cf\u65b9\u6cd5\n```python\nimport oss2\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\n\n\ndef get_oss_files(bucket, prefix, ext='.snappy.parquet', max_size=1 * 1024 * 1024 * 1024 * 1024):\n    '''\n    \u4f7f\u7528\u591a\u7ebf\u7a0b\u904d\u5386 OSS \u8def\u5f84\u4e0b\u7684\u6240\u6709\u76ee\u5f55\u3002", "top": 0, "createdAt": 1750929103, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-26", "dateLabelColor": "#0969da"}, "P10": {"htmlDir": "docs/post/MaxFrame-shi-xian-minhash Dedup.html", "labels": ["sql", "python", "MaxFrame"], "postTitle": "MaxFrame\u5b9e\u73b0minhash Dedup", "postUrl": "post/MaxFrame-shi-xian-minhash%20Dedup.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/10", "commentNum": 0, "wordCount": 7773, "description": "```python\nimport re\nfrom itertools import tee\nfrom typing import Iterable, Set, List\n\nimport numpy as np\nimport maxframe.dataframe as md\nfrom maxframe import options\nfrom maxframe.session import new_session\nfrom maxframe.udf import with_python_requirements\nfrom maxframe.learn.contrib.graph import connected_components\nfrom odps import ODPS\n\nimport logging\n\nlogging.basicConfig(level=logging.INFO)\n\nSEED = 42\nNON_ALPHA = re.compile('[^A-Za-z_0-9]')\nRNG = np.random.RandomState(SEED)\nMAX_HASH = np.uint64((1 << 32) - 1)\nMERSENNE_PRIME = np.uint64((1 << 61) - 1)\n\n\n# \u901a\u8fc7\u76f8\u4f3c\u5ea6\u9608\u503c\u548c\u54c8\u5e0c\u51fd\u6570\u4e2a\u6570\uff0c\u751f\u6210\u6761\u5e26\u6570\u91cf\u548c\u6761\u5e26\u884c\u6570\u53c2\u6570\ndef optimal_param(\n    threshold: float,\n    num_perm: int,\n    false_positive_weight: float = 0.5,\n    false_negative_weight: float = 0.5,\n):\n    from scipy.integrate import quad as integrate\n\n    def false_positive_probability(threshold: float, b: int, r: int):\n        '''Source: `datasketch.lsh`'''\n\n        def proba(s):\n            return 1 - (1 - s ** float(r)) ** float(b)\n\n        a, _ = integrate(proba, 0.0, threshold)\n        return a\n\n    def false_negative_probability(threshold: float, b: int, r: int):\n        '''Source: `datasketch.lsh`'''\n\n        def proba(s):\n            return 1 - (1 - (1 - s ** float(r)) ** float(b))\n\n        a, _ = integrate(proba, threshold, 1.0)\n        return a\n\n    min_error = float('inf')\n    opt = (0, 0)\n    for b in range(1, num_perm + 1):\n        max_r = int(num_perm / b)\n        for r in range(1, max_r + 1):\n            fp = false_positive_probability(threshold, b, r)\n            fn = false_negative_probability(threshold, b, r)\n            error = fp * false_positive_weight + fn * false_negative_weight\n            if error < min_error:\n                min_error = error\n                opt = (b, r)\n    return opt\n\n\n# \u4f9d\u8d56 xxhash \u5b8c\u6210 hash\n@with_python_requirements('xxhash')\ndef generate_hash_values(row):\n    idx = str(row[0])\n    content = row[1]\n\n    print(idx, content[:10], flush=True)\n\n    import xxhash\n\n    def ngrams(sequence: List[str], n: int, min_length: int = 5) -> Iterable:\n        if len(sequence) < min_length:\n            return []\n\n        iterables = tee(sequence, n)\n        for i, sub_iterable in enumerate(iterables):\n            for _ in range(i):\n                next(sub_iterable, None)\n        return zip(*iterables)\n\n    def ngram_hashes(content: str, n: int, min_length: int = 5) -> Set[int]:\n        import xxhash\n\n        # ========== edit ===========\n        tokens: List[str] = NON_ALPHA.split(content.lower())\n        ng: set[bytes] = {\n            bytes(' '.join(t).lower(), 'utf-8') for t in ngrams(tokens, n, min_length)\n        }\n        return {xxhash.xxh32_intdigest(n) for n in ng}\n\n    # \u83b7\u53d6 hash \u751f\u6210\u7684\u6392\u5217\u7684\u53c2\u6570\n    a, b = PERMUTATIONS\n\n    # \u83b7\u5f97 ngram hash\n    hashes = np.array(\n        list(ngram_hashes(content, args_ngram_size, args_min_length)), dtype=np.uint64\n    )\n\n    # \u5982\u679c\u957f\u5ea6\u4e0d\u8db3\uff0c\u4e0d\u8fdb\u884c\u76f8\u4f3c\u5ea6\u5224\u5b9a\n    if len(hashes) == 0:\n        return\n\n    # \u901a\u8fc7\u7b97\u6cd5\u4e3a\u6bcf\u4e2a ngram \u751f\u6210\u591a\u4e2a hash \u503c\n    chunk_size = 100\n    min_hashes = np.full(args_num_perm, MAX_HASH)\n    for i in range(0, len(hashes), chunk_size):\n        chunk = hashes[i : i + chunk_size]\n        p_hashes = ((np.outer(chunk, a) + b) % MERSENNE_PRIME) & MAX_HASH\n        min_hashes = np.minimum(min_hashes, p_hashes.min(axis=0))\n\n    # \u751f\u6210\u6761\u5e26\u7684 hash\n    Hs = [bytes(min_hashes[start:end].byteswap().data) for start, end in HASH_RANGES]\n\n    # \u8fd4\u56de\u7ed3\u679c\uff0c\u7ed3\u679c\u4e3a\u6bcf\u4e2a\u6761\u5e26\u8fd4\u56de\u4e00\u884c\u6570\u636e\n    for band_idx, H in enumerate(Hs):\n        yield band_idx, H.hex(), idx\n\nmapper_memory = 4096\nreducer_memory = 12288\njoiner_memory = 12288\nmapper_split_size = 1024\ninstance_num = 50000\n\ninput_table = 'xxx'\noutput_table = 'xxxx1'\n\n# content_hash\nprocess_column = 'content_hash'  #\u4e4b\u540e\u9700\u8981\u6539\u4e3acontent\nlifecycle = 365\npartitions = None  # or None\n\n# \u76f8\u4f3c\u5ea6\u9608\u503c\nargs_threshold = 0.6  # 0.6\n# \u6587\u672c\u957f\u5ea6\u9650\u5236\nargs_min_length = 5  # 5\nargs_ngram_size = 5  # 5\n# hash \u51fd\u6570\u4e2a\u6570\nargs_num_perm = 256  # 256\n\n# \u5173\u95ed\u67e5\u8be2\u52a0\u901f\uff0c\u5728\u8fd9\u4e2a\u573a\u666f\u8ba1\u7b97\u65f6\u95f4\u504f\u957f\uff0c\u4e0d\u9002\u7528mcqa\noptions.sql.enable_mcqa = False\n\nsql_settings = {\n    'odps.namespace.schema': 'true',\n    'odps.session.image': 'common',\n    'odps.function.timeout': 3600,\n    'odps.sql.mapper.memory': mapper_memory,  # \u5f39\u5185\n    'odps.stage.mapper.mem': mapper_memory,  # \u5f39\u5916\n    'odps.sql.reducer.memory': reducer_memory,  # \u5f39\u5185\n    'odps.stage.reducer.mem': reducer_memory,  # \u5f39\u5916\n    'odps.sql.joiner.memory': joiner_memory,  # \u5f39\u5185\n    'odps.stage.joiner.mem': joiner_memory,  # \u5f39\u5916\n    'odps.stage.mapper.split.size': mapper_split_size,\n    'odps.sql.cfile2.field.maxsize': 268435456,\n    'odps.task.merge.enabled': False,\n    'odps.sql.allow.fullscan': 'true',\n    'odps.dag2.compound.config': 'fuxi.worker.reuse.policy:NO_REUSE',\n    'odps.sql.window.function.newimpl': 'false',\n}\n\n# \u8bbe\u7f6e\u6700\u5927\u5217\u7684\u5927\u5c0f\uff0c\u5e76\u53d1\nif instance_num:\n    sql_settings.update(\n        {\n            'odps.sql.split.dop': {input_table: int(instance_num)},\n            'odps.stage.reducer.num': 5000,\n            'odps.stage.joiner.num': 5000,\n            'odps.sql.sys.flag.fuxi_MaxTaskWorkerCount': int(instance_num),\n            'odps.sql.max.desired.parallelism': int(instance_num),\n            'odps.job.workers.limit': int(instance_num),\n        }\n    )\noptions.sql.settings = sql_settings\noptions.dag.settings.update({'codegen.groupby_first_value_allowed': 'true'})\n\no = ODPS(\n    access_id='',\n    secret_access_key='',\n    project='xxx',\n    # endpoint='http://service.cn-hangzhou.maxcompute.aliyun.com/api',\n    endpoint='https://service.cn-hangzhou-vpc.maxcompute.aliyun-inc.com/api',\n)\n\nsession = new_session(o)\nprint('session id: ', session.session_id, flush=True)\nprint('session logview: ', session.get_logview_address(), flush=True)\n\nB, R = optimal_param(args_threshold, args_num_perm)\n\n# \u751f\u6210 HashRange\nHASH_RANGES = [(i * R, (i + 1) * R) for i in range(B)]\n\n# \u751f\u6210 Hash \u51fd\u6570\u53c2\u6570\nPERMUTATIONS = np.array(\n    [\n        (\n            RNG.randint(1, MERSENNE_PRIME, dtype=np.uint64),\n            RNG.randint(0, MERSENNE_PRIME, dtype=np.uint64),\n        )\n        for _ in range(args_num_perm)\n    ],\n    dtype=np.uint64,\n).T\n\ndf = md.read_odps_table(input_table, partitions=partitions)\n\n# \u76f4\u63a5\u5bf9\u76f8\u540c\u6587\u672c\u53bb\u91cd\ndf = df.drop_duplicates(subset=[process_column], keep='first')\n\n# # \u8fc7\u6ee4 text \u4e3a\u7a7a\u7684\u884c, \u751f\u6210 index \u5217\ndf = df.reset_index(drop=False).rename(columns={'index': '_doc_id'})\n# \u89e6\u53d1\u8ba1\u7b97\u5e76\u7f13\u5b58\u7ed3\u679c, \u901a\u8fc7 display \u9884\u89c8\ndf.execute()\n\n# # \u6295\u5f71\u51fa\u6240\u9700\u7684\u6570\u636e\ndocid_docinfo_df = df[['_doc_id', process_column]]\n\n# # \u5e94\u7528 udtf \u751f\u6210\u6240\u6709\u7684 MinHash \u548c LSH\nhash_df = docid_docinfo_df.mf.flatmap(\n    generate_hash_values,\n    dtypes={'band_idx': np.int_, 'hash': np.str_, '_doc_id': np.str_},\n    raw=True,\n)\n\nhash_df_temp = 'tmp_hash_df'\nmd.to_odps_table(\n    hash_df, hash_df_temp, index=False, overwrite=True, lifecycle=7\n).execute()\n\ncomponents_df = md.read_odps_query(\n    f'''\n    select distinct similar_docs as index, similar_docs as id, _doc_id as component from (\n        select cast (_doc_id as bigint) as similar_docs,\n                            MIN(cast (_doc_id as bigint)) over(PARTITION BY band_idx, hash) as _doc_id,\n                            RANK() over (PARTITION BY band_idx,hash ORDER BY cast (_doc_id as bigint) ASC) as rnk from {hash_df_temp}\n    ) where rnk > 1\n    ''',\n    index_col='index',\n)\nconverged = False\n\nround = 0\n# \u8ba1\u7b97\u5b8c\u6574\u8054\u901a\u5206\u91cf\nwhile not converged:\n    round = round + 1\n    components_df, converged_scalar = connected_components(\n        components_df, 'id', 'component', 6\n    )\n    session.execute(components_df, converged_scalar)\n    converged = converged_scalar.fetch()\n\ncomponents_df = components_df.set_index('id')\nresult_df = df.merge(components_df, left_on='_doc_id', right_index=True, how='left')\nresult_df = result_df[result_df['component'].isnull()]\nresult_df = result_df.drop(['component', '_doc_id'], axis=1)\n\nmd.to_odps_table(\n    result_df, output_table, lifecycle=lifecycle, overwrite=True, index=False\n).execute()\n\nsession.destroy()\n```\u3002", "top": 0, "createdAt": 1750929262, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-26", "dateLabelColor": "#0969da"}}, "singeListJson": {"P8": {"htmlDir": "docs/resume.html", "labels": ["resume"], "postTitle": "\u4e2a\u4eba\u7b80\u5386", "postUrl": "resume.html", "postSourceUrl": "https://github.com/enderTree/blog/issues/8", "commentNum": 0, "wordCount": 2025, "description": "# \u4e2a\u4eba\u4fe1\u606f\n\n- \u51b7\u718a/\u7537/1990\n- \u672c\u79d1/\u5317\u6781\u5927\u5b66\u8ba1\u7b97\u673a\u7cfb\n- \u5de5\u4f5c\u5e74\u9650\uff1a3\u5e74\n- \u5fae\u535a\uff1a[@Easy](http://weibo.com/easy) \uff08\u5982\u679c\u6ca1\u6709\u6280\u672f\u76f8\u5173\u5185\u5bb9\uff0c\u4e5f\u53ef\u4ee5\u4e0d\u653e\uff09\n- \u6280\u672f\u535a\u5ba2\uff1ahttp://old.ftqq.com ( \u4f7f\u7528GitHub Host\u7684Big\u8f83\u9ad8  )\n- Github\uff1ahttp://github.com/easychen ( \u6709\u539f\u521brepo\u7684Github\u5e10\u53f7\u4f1a\u6781\u5927\u7684\u63d0\u5347\u4f60\u7684\u4e2a\u4eba\u54c1\u724c  )\n- \u671f\u671b\u804c\u4f4d\uff1aPHP\u9ad8\u7ea7\u7a0b\u5e8f\u5458\uff0c\u5e94\u7528\u67b6\u6784\u5e08\n- \u671f\u671b\u85aa\u8d44\uff1a\u7a0e\u524d\u6708\u85aa15k~20k\uff0c\u7279\u522b\u559c\u6b22\u7684\u516c\u53f8\u53ef\u4f8b\u5916\n- \u671f\u671b\u57ce\u5e02\uff1a\u5317\u4eac\n\n# \u5de5\u4f5c\u7ecf\u5386\n\n\uff08\u5de5\u4f5c\u7ecf\u5386\u6309\u9006\u5e8f\u6392\u5217\uff0c\u6700\u65b0\u7684\u5728\u6700\u524d\u8fb9\uff0c\u6309\u516c\u53f8\u505a\u4e00\u7ea7\u5206\u7ec4\uff0c\u516c\u53f8\u5185\u6309\u4e8c\u7ea7\u5206\u7ec4\uff09\n\n## ABC\u516c\u53f8 \uff08 2012\u5e749\u6708 ~ 2014\u5e749\u6708 \uff09\n\n### DEF\u9879\u76ee\n\n\u6211\u5728\u6b64\u9879\u76ee\u8d1f\u8d23\u4e86\u54ea\u4e9b\u5de5\u4f5c\uff0c\u5206\u522b\u5728\u54ea\u4e9b\u5730\u65b9\u505a\u5f97\u51fa\u8272/\u548c\u522b\u4eba\u4e0d\u4e00\u6837/\u6210\u957f\u5feb\uff0c\u8fd9\u4e2a\u9879\u76ee\u4e2d\uff0c\u6211\u6700\u56f0\u96be\u7684\u95ee\u9898\u662f\u4ec0\u4e48\uff0c\u6211\u91c7\u53d6\u4e86\u4ec0\u4e48\u63aa\u65bd\uff0c\u6700\u540e\u7ed3\u679c\u5982\u4f55\u3002", "top": 0, "createdAt": 1750851641, "style": "", "script": "<script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'></script>", "head": "", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "createdDate": "2025-06-25", "dateLabelColor": "#0969da"}}, "labelColorDict": {"bug": "#d73a4a", "java": "#819a26", "MaxFrame": "#81e59d", "python": "#379210", "resume": "#a086be", "sql": "#a3bf9d", "udf": "#9b26f8", "\u6570\u4ed3": "#3bc693"}, "displayTitle": "ender'Blog", "faviconUrl": "https://github.githubassets.com/favicons/favicon.svg", "ogImage": "https://github.githubassets.com/favicons/favicon.svg", "primerCSS": "<link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />", "homeUrl": "https://enderTree.github.io/blog", "prevUrl": "disabled", "nextUrl": "disabled"}